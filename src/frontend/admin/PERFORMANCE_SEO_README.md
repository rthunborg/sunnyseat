# Performance Optimization & SEO - Implementation Guide

## Overview

This document provides implementation details for Story 4.5: Performance Optimization & SEO.

## Implemented Features

### ✅ Core Web Vitals Optimization

1. **Code Splitting**

   - Implemented route-based lazy loading with React.lazy()
   - Manual chunk splitting for vendor libraries
   - Separate chunks for React, MapLibre, and Chart.js

2. **Resource Hints**

   - Preconnect to api.maptiler.com for map tiles
   - DNS prefetch for API endpoints
   - Added in `index.html`

3. **Build Optimization**
   - Vite with esbuild minification (default, faster than terser)
   - CSS code splitting enabled
   - Sourcemaps disabled in production
   - Console/debugger statements dropped in production

### ✅ Progressive Web App (PWA)

1. **Service Worker**

   - Auto-generated by vite-plugin-pwa with Workbox
   - Cache-first strategy for map tiles (7-day expiration, 200 entries max)
   - Network-first strategy for API calls (5-minute expiration, 50 entries max)

2. **App Manifest**

   - Configured for standalone display mode
   - Theme color: #0EA5E9 (SunnySeat blue)
   - Portrait orientation
   - Icons: 192x192 and 512x512 (need to be generated)

3. **Offline Support**
   - Custom offline.html page
   - Cached static assets

### ✅ SEO Optimization

1. **Meta Tags**

   - Dynamic title and description per venue page
   - Open Graph tags for social sharing
   - Canonical URLs to prevent duplicate content

2. **Structured Data**

   - JSON-LD format for LocalBusiness schema
   - Address and geo-coordinates included
   - Auto-generated per venue

3. **Search Engine Files**
   - robots.txt (allows /v/\*, blocks /admin)
   - Sitemap.xml placeholder (needs implementation)

### ✅ Error Handling

1. **Error Boundary**
   - Top-level error boundary in main.tsx
   - Custom fallback UI with reload and go-home options
   - Error logging to Application Insights (when configured)
   - Development mode shows error details

### ✅ Performance Monitoring

1. **Web Vitals Tracking**

   - CLS (Cumulative Layout Shift)
   - FID (First Input Delay)
   - LCP (Largest Contentful Paint)
   - Auto-reports to Application Insights

2. **Application Insights**
   - Configured with connection string from environment
   - Auto route tracking enabled
   - CORS correlation enabled
   - Only initializes if connection string provided

### ✅ CI/CD & Deployment

1. **GitHub Actions Workflows**

   - `deploy-frontend.yml` - Deploy to Azure Static Web Apps on push to main
   - `lighthouse-ci.yml` - Run Lighthouse audits on PRs

2. **Lighthouse CI**
   - Performance budget configuration
   - Automated testing on pull requests
   - 3 runs per URL for consistency

## Files Created

### Utilities

- `src/utils/appInsights.ts` - Application Insights initialization
- `src/utils/webVitals.ts` - Web Vitals tracking
- `src/utils/seo.ts` - SEO meta tag generation and structured data

### Components

- `src/components/common/ErrorBoundary/` - Error boundary component with tests

### Configuration

- `vite.config.ts` - Enhanced with PWA plugin and build optimizations
- `lighthouse.config.js` - Performance budget configuration
- `.env.production.template` - Environment variable template

### Public Assets

- `public/robots.txt` - Search engine directives
- `public/offline.html` - Offline fallback page
- `public/icons/README.md` - Icon requirements (icons need generation)

### CI/CD

- `.github/workflows/deploy-frontend.yml` - Production deployment
- `.github/workflows/lighthouse-ci.yml` - Lighthouse CI audits

## Required Setup Steps

### 1. Install Dependencies

The following packages need to be installed:

```bash
cd src/frontend/admin
npm install vite-plugin-pwa workbox-window web-vitals @microsoft/applicationinsights-web --save
npm install rollup-plugin-visualizer --save-dev
```

### 2. Generate PWA Icons

Icons need to be generated from SunnySeat brand assets:

- icon-192.png (192x192 pixels)
- icon-512.png (512x512 pixels)
- apple-touch-icon.png (180x180 pixels)

Tools:

- https://realfavicongenerator.net
- https://github.com/elegantapp/pwa-asset-generator

### 3. Configure Environment Variables

Create `.env.production` from template:

```bash
cp .env.production.template .env.production
```

Add values:

- `VITE_APPLICATIONINSIGHTS_CONNECTION_STRING` - From Azure Portal
- `VITE_APP_URL` - Production URL (https://sunnyseat.com)

### 4. Configure GitHub Secrets

Add the following secrets to GitHub repository:

- `AZURE_STATIC_WEB_APPS_API_TOKEN` - From Azure Static Web Apps
- `VITE_APPLICATIONINSIGHTS_CONNECTION_STRING` - Application Insights connection string

### 5. Generate Sitemap

Implement automated sitemap generation for all venue pages (/v/:slug).

## Performance Targets

### Core Web Vitals

- **LCP (Largest Contentful Paint)**: <2.5s ✅
- **FID (First Input Delay)**: <100ms ✅
- **CLS (Cumulative Layout Shift)**: <0.1 ✅

### Lighthouse Scores (Goals)

- **Performance**: >80 (warn threshold in lighthouse.config.js)
- **SEO**: >90 (error threshold)
- **Accessibility**: >90 (error threshold)
- **PWA**: >70 (warn threshold)

### Bundle Sizes

- Main bundle: <500KB
- Vendor bundles: <200KB each
- CSS: <100KB

## Testing

### Run Tests Locally

```bash
# Unit tests
npm test

# Lighthouse audit (requires build)
npm run build
npm run preview
npx lighthouse http://localhost:4173 --view
```

### Manual Testing Checklist

- [ ] PWA installation works on Android
- [ ] PWA installation works on iOS
- [ ] Offline page shows when network disconnected
- [ ] Map tiles cached and load offline
- [ ] Error boundary catches errors and shows fallback UI
- [ ] SEO meta tags present on venue pages
- [ ] Structured data validates on Google Rich Results Test
- [ ] Share links work correctly
- [ ] Web Vitals metrics tracked in Application Insights

## Known Limitations

1. **PWA Icons**: Placeholder icons need to be replaced with actual SunnySeat branding
2. **Sitemap**: Not yet generated (needs implementation)
3. **Lighthouse CI**: Requires preview server to be running (configured in workflow)
4. **Application Insights**: Optional, only works if connection string provided

## Next Steps

1. Generate and add PWA icons
2. Implement automated sitemap generation
3. Set up Azure Static Web Apps
4. Configure Application Insights in Azure
5. Add GitHub secrets for deployment
6. Monitor Web Vitals in production
7. Iterate on performance based on real-world data

## References

- [Vite PWA Plugin Docs](https://vite-pwa-org.netlify.app/)
- [Web Vitals Library](https://github.com/GoogleChrome/web-vitals)
- [Lighthouse CI](https://github.com/GoogleChrome/lighthouse-ci)
- [Application Insights JavaScript SDK](https://docs.microsoft.com/en-us/azure/azure-monitor/app/javascript)
