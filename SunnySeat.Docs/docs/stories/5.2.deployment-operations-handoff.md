# Story 5.2: Deployment & Operations Handoff

## Status - Not started

**Epic:** 5 - Deployment & Operations  
**Priority:** Critical Path  
**Status:** Not Started  
**Dependencies:** Epic 4 Complete (Public Interface)

## Story Description

Create comprehensive deployment documentation and operations runbooks to enable smooth production deployment and ongoing operational support of the SunnySeat application.

## User Story

_As an_ operations team member, _I want_ complete deployment and operational documentation, _so that_ I can confidently deploy, monitor, and maintain the SunnySeat application in production.

## Acceptance Criteria

### Deployment Documentation

- [ ] Step-by-step production deployment guide created
- [ ] Pre-deployment checklist documented
- [ ] Post-deployment validation procedures defined
- [ ] Rollback procedures documented with tested examples
- [ ] Database migration procedures documented
- [ ] Zero-downtime deployment strategy documented

### Operations Runbooks

- [ ] Incident response procedures documented
- [ ] Common troubleshooting scenarios documented
- [ ] Health check procedures defined
- [ ] Performance monitoring guide created
- [ ] Log analysis guide created
- [ ] Backup and restore procedures documented

### Monitoring & Alerting

- [ ] Critical alerts documented with response procedures
- [ ] Monitoring dashboard usage guide created
- [ ] SLA definitions documented (99.9% uptime target)
- [ ] On-call rotation procedures defined (if applicable)
- [ ] Escalation procedures documented

### Security Operations

- [ ] Security incident response plan documented
- [ ] Credential rotation procedures defined
- [ ] Access control management documented
- [ ] Vulnerability management procedures defined
- [ ] Compliance checklist created

### Maintenance Procedures

- [ ] Routine maintenance tasks documented
- [ ] Database maintenance procedures defined
- [ ] Cache management procedures documented
- [ ] Log rotation and retention policies defined
- [ ] Dependency update procedures documented

### Knowledge Transfer

- [ ] Architecture overview for operations team
- [ ] Common development tasks guide
- [ ] API documentation for operations
- [ ] Configuration management guide
- [ ] Disaster recovery procedures

## Documentation Structure

```
SunnySeat.Docs/docs/ops/
├── deployment/
│   ├── production-deployment-guide.md
│   ├── pre-deployment-checklist.md
│   ├── post-deployment-validation.md
│   ├── rollback-procedures.md
│   └── database-migrations.md
├── runbooks/
│   ├── incident-response.md
│   ├── troubleshooting-guide.md
│   ├── health-checks.md
│   ├── performance-monitoring.md
│   └── common-issues.md
├── monitoring/
│   ├── dashboard-guide.md
│   ├── alert-response-playbook.md
│   ├── log-analysis-guide.md
│   └── metrics-reference.md
├── security/
│   ├── incident-response-plan.md
│   ├── credential-rotation.md
│   ├── access-control-procedures.md
│   └── vulnerability-management.md
├── maintenance/
│   ├── routine-tasks.md
│   ├── database-maintenance.md
│   ├── cache-management.md
│   ├── log-retention.md
│   └── disaster-recovery.md
└── knowledge-transfer/
    ├── architecture-overview.md
    ├── configuration-guide.md
    ├── api-reference-operations.md
    └── sla-commitments.md
```

## Production Deployment Guide Content

### Pre-Deployment Checklist

**Code Readiness:**

- [ ] All Epic 4 acceptance criteria verified
- [ ] Integration tests passing in staging
- [ ] Performance tests passing (load testing completed)
- [ ] Security scan completed (no critical vulnerabilities)
- [ ] Code review completed and approved
- [ ] Release notes prepared

**Infrastructure Readiness:**

- [ ] Production environment provisioned (Story 1.7)
- [ ] Database backup created and verified
- [ ] Monitoring dashboards configured
- [ ] Alert rules tested and active
- [ ] CDN configuration verified
- [ ] SSL certificates valid and up-to-date

**Data Readiness:**

- [ ] Building data imported and validated (≥50 venues)
- [ ] Venue patio polygons mapped
- [ ] Data quality metrics reviewed
- [ ] Test data cleaned from production database

**Third-Party Services:**

- [ ] Weather API accounts configured and tested
- [ ] MapTiler API key configured
- [ ] API rate limits verified
- [ ] Fallback services tested

**Team Readiness:**

- [ ] Operations team trained on deployment procedures
- [ ] On-call schedule established
- [ ] Rollback plan reviewed with team
- [ ] Stakeholders notified of deployment window
- [ ] Communication channels established (Slack, email)

### Deployment Steps

**Phase 1: Database Migration**

1. Create production database backup
2. Run database migrations via Azure CLI:
   ```bash
   az containerapp exec \
     --name sunnyseat-api-prod \
     --resource-group sunnyseat-prod-rg \
     --command "dotnet ef database update --project /app/src/backend/SunnySeat.Data"
   ```
3. Verify migration success
4. Test database connectivity

**Phase 2: API Deployment**

1. Build and push Docker image with production tag
2. Update Container App with new image:
   ```bash
   az containerapp update \
     --name sunnyseat-api-prod \
     --resource-group sunnyseat-prod-rg \
     --image ghcr.io/your-org/sunnyseat-api:v1.0.0
   ```
3. Monitor Container App logs during startup
4. Verify health endpoint responds

**Phase 3: Frontend Deployment**

1. Build production frontend bundle
2. Upload to Azure Storage Static Website:
   ```bash
   az storage blob upload-batch \
     --account-name sunnyseatprod \
     --source ./build \
     --destination '$web'
   ```
3. Purge Azure Front Door cache:
   ```bash
   az afd endpoint purge \
     --resource-group sunnyseat-prod-rg \
     --profile-name sunnyseat-frontdoor \
     --endpoint-name sunnyseat \
     --content-paths '/*'
   ```

**Phase 4: Verification**

1. Verify health endpoints (API, database)
2. Execute smoke tests
3. Test key user journeys manually
4. Verify monitoring dashboards

### Post-Deployment Validation

**Health Checks:**

- [ ] API health endpoint: `GET /health` returns 200
- [ ] Database health: `GET /health/database` returns 200
- [ ] Redis health: `GET /health/cache` returns 200
- [ ] Weather API integration: Fetch current weather data
- [ ] Map tiles loading correctly

**Smoke Tests:**

- [ ] Search for sunny patios near Gothenburg city center
- [ ] View venue detail page with sun timeline
- [ ] Submit feedback on a venue
- [ ] Admin login and view dashboard
- [ ] Create/edit patio polygon (admin)

**Performance Validation:**

- [ ] API response time p95 < 400ms
- [ ] Frontend load time < 2 seconds on 4G
- [ ] Map rendering < 2 seconds
- [ ] Database query performance within targets

**Monitoring Validation:**

- [ ] Application Insights receiving telemetry
- [ ] Logs flowing to Log Analytics
- [ ] Dashboards displaying real-time data
- [ ] Alerts configured and tested
- [ ] Error tracking operational

**Stakeholder Notification:**

- [ ] Deployment completion email sent
- [ ] Release notes shared
- [ ] Known issues communicated
- [ ] Support contact information provided

## Rollback Procedures

### Rollback Triggers

Execute rollback if any of these conditions occur:

- Error rate >5% for 5 minutes
- API response time p95 >2 seconds for 10 minutes
- Health check failures >3 consecutive checks
- Critical bug discovered affecting user experience
- Database corruption detected
- Security vulnerability discovered

### Rollback Steps

**Immediate Rollback (API):**

```bash
# Rollback to previous container image
az containerapp update \
  --name sunnyseat-api-prod \
  --resource-group sunnyseat-prod-rg \
  --image ghcr.io/your-org/sunnyseat-api:previous-version

# Verify rollback success
curl https://api.sunnyseat.com/health
```

**Database Rollback (if migrations failed):**

```bash
# Restore from backup
az postgres flexible-server restore \
  --resource-group sunnyseat-prod-rg \
  --name sunnyseat-psql-prod \
  --restore-point-in-time "2025-10-06T18:00:00Z" \
  --source-server sunnyseat-psql-prod
```

**Frontend Rollback:**

```bash
# Re-upload previous version
az storage blob upload-batch \
  --account-name sunnyseatprod \
  --source ./previous-build \
  --destination '$web' \
  --overwrite

# Purge CDN cache
az afd endpoint purge \
  --resource-group sunnyseat-prod-rg \
  --profile-name sunnyseat-frontdoor \
  --endpoint-name sunnyseat \
  --content-paths '/*'
```

**Communication During Rollback:**

1. Notify stakeholders immediately
2. Post status update (status page if available)
3. Document rollback reason
4. Schedule post-mortem meeting

## Incident Response Playbook

### Severity Definitions

**P0 - Critical (Immediate Response):**

- Complete service outage
- Data loss or corruption
- Security breach
- Response time: <15 minutes

**P1 - High (Urgent Response):**

- Partial service degradation
- Key features unavailable
- Performance significantly degraded
- Response time: <1 hour

**P2 - Medium (Standard Response):**

- Minor feature issues
- Non-critical bugs
- Performance slightly degraded
- Response time: <4 hours

**P3 - Low (Planned Response):**

- Cosmetic issues
- Feature requests
- Documentation updates
- Response time: Next business day

### Incident Response Steps

1. **Detect:** Alert fires or user report received
2. **Assess:** Determine severity and impact
3. **Respond:** Execute appropriate runbook
4. **Communicate:** Update stakeholders
5. **Resolve:** Fix issue or implement workaround
6. **Verify:** Confirm resolution
7. **Document:** Record incident details
8. **Review:** Post-mortem for P0/P1 incidents

## Common Troubleshooting Scenarios

### Scenario 1: API Not Responding

**Symptoms:** Health endpoint timeout, 503 errors

**Diagnosis:**

```bash
# Check Container App logs
az containerapp logs show \
  --name sunnyseat-api-prod \
  --resource-group sunnyseat-prod-rg \
  --tail 100

# Check Container App status
az containerapp show \
  --name sunnyseat-api-prod \
  --resource-group sunnyseat-prod-rg \
  --query properties.runningStatus
```

**Resolution:**

1. Check if container is running
2. Review logs for errors
3. Check resource limits (CPU, memory)
4. Restart container if needed
5. Scale up if resource constrained

### Scenario 2: Database Connection Errors

**Symptoms:** "Unable to connect to database" errors

**Diagnosis:**

```bash
# Test database connectivity
az postgres flexible-server show \
  --resource-group sunnyseat-prod-rg \
  --name sunnyseat-psql-prod

# Check firewall rules
az postgres flexible-server firewall-rule list \
  --resource-group sunnyseat-prod-rg \
  --server-name sunnyseat-psql-prod
```

**Resolution:**

1. Verify database is running
2. Check firewall rules allow Container App
3. Verify connection string in Key Vault
4. Check database CPU/memory usage
5. Review slow query log

### Scenario 3: Weather API Integration Failure

**Symptoms:** No weather data, confidence scores at 60%

**Diagnosis:**

```bash
# Check Application Insights for API errors
az monitor app-insights query \
  --app sunnyseat-appinsights-prod \
  --analytics-query "exceptions | where timestamp > ago(1h) | where customDimensions.Component == 'WeatherService'"
```

**Resolution:**

1. Check Yr.no API status
2. Verify fallback to OpenWeatherMap working
3. Check API rate limits not exceeded
4. Verify API keys in Key Vault
5. Review weather service logs

### Scenario 4: High Response Times

**Symptoms:** API response time >1 second

**Diagnosis:**

- Check Application Insights performance metrics
- Review slow database queries
- Check Redis cache hit rate
- Monitor Container App CPU/memory

**Resolution:**

1. Scale up Container App instances
2. Optimize slow queries
3. Verify cache is working
4. Review recent code changes
5. Enable database query caching

## Maintenance Procedures

### Routine Maintenance Tasks

**Daily:**

- Review error logs for anomalies
- Check monitoring dashboards
- Verify backup completion

**Weekly:**

- Review performance metrics trends
- Check for dependency updates
- Analyze cost reports
- Review security alerts

**Monthly:**

- Rotate credentials (API keys, passwords)
- Review and update documentation
- Conduct disaster recovery drill
- Analyze user feedback trends
- Update SSL certificates if needed

### Database Maintenance

**Backup Verification:**

```bash
# List recent backups
az postgres flexible-server backup list \
  --resource-group sunnyseat-prod-rg \
  --server-name sunnyseat-psql-prod

# Test restore (to separate server)
az postgres flexible-server restore \
  --resource-group sunnyseat-test-rg \
  --name sunnyseat-psql-test-restore \
  --source-server sunnyseat-psql-prod \
  --restore-point-in-time "2025-10-06T00:00:00Z"
```

**Index Maintenance:**

```sql
-- Reindex spatial indexes
REINDEX INDEX CONCURRENTLY idx_venues_location;
REINDEX INDEX CONCURRENTLY idx_patios_geometry;
REINDEX INDEX CONCURRENTLY idx_buildings_geometry;

-- Analyze statistics
ANALYZE venues;
ANALYZE patios;
ANALYZE buildings;
```

## Disaster Recovery

### Recovery Time Objective (RTO): 4 hours

### Recovery Point Objective (RPO): 1 hour

**Disaster Scenarios:**

1. Azure region outage
2. Database corruption
3. Complete data center failure
4. Accidental data deletion

**Recovery Procedures:**

**Scenario: Database Corruption**

1. Identify corruption extent
2. Stop all writes to database
3. Restore from most recent backup
4. Replay transaction logs if available
5. Verify data integrity
6. Resume service

**Scenario: Azure Region Outage**

1. Assess outage scope and estimated recovery
2. If >1 hour, initiate failover to secondary region (if configured)
3. Update DNS to point to secondary region
4. Communicate with users about degraded service
5. Monitor Azure status for primary region recovery

## Knowledge Transfer Checklist

**Operations Team Training:**

- [ ] Architecture overview presentation delivered
- [ ] Deployment procedures walkthrough completed
- [ ] Monitoring and alerting training completed
- [ ] Incident response drill conducted
- [ ] Troubleshooting scenarios practiced
- [ ] Access credentials provided securely

**Documentation Handoff:**

- [ ] All runbooks reviewed with team
- [ ] Questions answered and documented
- [ ] Contact list created for escalations
- [ ] On-call schedule established
- [ ] Knowledge base articles created

## Definition of Done

- [ ] All deployment documentation complete and reviewed
- [ ] Operations runbooks tested with sample scenarios
- [ ] Incident response playbook validated
- [ ] Troubleshooting guides cover common issues
- [ ] Monitoring and alerting fully documented
- [ ] Knowledge transfer session completed with operations team
- [ ] Production deployment successfully completed using this documentation
- [ ] Post-deployment monitoring verified for 48 hours
- [ ] Stakeholder sign-off on documentation
- [ ] All acceptance criteria met

## Dependencies

**Requires:**

- Epic 4 complete (Public Interface deployed to staging)
- Story 1.7 complete (Production infrastructure provisioned)
- Story 1.6 complete (CI/CD pipeline operational)
- All third-party services configured (weather APIs, MapTiler)

**Enables:**

- Production launch
- Ongoing operational support
- Incident management
- Continuous improvement

## Notes

- Keep documentation in version control alongside code
- Update runbooks based on real incident learnings
- Schedule regular documentation reviews
- Maintain changelog for operational procedures
- Consider automating routine maintenance tasks
- Use monitoring data to refine alert thresholds
- Document all production changes in change log
- Establish feedback loop from operations to development

---

**Created:** October 6, 2025  
**Owner:** Operations Team Lead  
**Reviewers:** Development Team, Security Team, Product Owner
