# Story 5.1 - Deployment Setup Checklist

## Status - In Progress (PWA Icons Complete, Infrastructure Pending)

This checklist covers the deployment configuration steps required to complete Story 5.1 deployment using Infrastructure as Code (IaC) with Azure Bicep.

**Epic:** 5 - Deployment & Operations  
**Priority:** Critical Path  
**Status:** In Progress  
**Dependencies:** Epic 4 Complete (Public Interface)

**Note:** This story uses Infrastructure as Code (Bicep) for all Azure resources. See `docs/ops/DEPLOYMENT-GUIDE.md` for complete deployment instructions.

## Prerequisites

- [ ] Azure subscription with appropriate permissions (Owner/Contributor)
- [ ] Azure CLI installed and configured (`az --version`)
- [ ] GitHub repository access with admin permissions
- [x] SunnySeat brand assets (logo) for PWA icon generation
- [ ] OpenWeatherMap API key (https://openweathermap.org/api)
- [ ] PowerShell 7+ (Windows) or Bash (Linux/Mac)

## 1. PWA Icons Generation

### Required Icons

- [x] Generate icon-192.png (192x192 pixels) from SunnySeat logo
- [x] Generate icon-512.png (512x512 pixels) from SunnySeat logo
- [x] Generate apple-touch-icon.png (180x180 pixels) from SunnySeat logo
- [x] Place all icons in `src/frontend/admin/public/icons/` directory

### Tools

- Option 1: https://realfavicongenerator.net
- Option 2: https://github.com/elegantapp/pwa-asset-generator
- Option 3: Manual creation with design software (Figma, Photoshop, etc.)

**Checklist:**

```bash
cd src/frontend/admin/public/icons/
# Place generated icons here:
# - icon-192.png
# - icon-512.png
# - apple-touch-icon.png (also copy to public/ root for iOS)
```

## 2. Azure Infrastructure Deployment (IaC with Bicep)

**See:** `docs/ops/DEPLOYMENT-GUIDE.md` for detailed instructions.  
**Note for Azure for Students:** See `infrastructure/AZURE-FOR-STUDENTS.md` for region restrictions and workarounds.

### Initial Azure Setup

- [ ] Login to Azure CLI (`az login`)
- [ ] Set active subscription
- [ ] Run deployment script:
  ```powershell
  cd D:\SunnySeat\infrastructure
  .\scripts\deploy-dev.ps1
  ```
  **Note:** Script automatically handles:
  - Resource group creation
  - Secrets Key Vault (tries multiple regions for Azure for Students compatibility)
  - Secret generation (PostgreSQL password, JWT key)
  - Bicep template validation
  - Full infrastructure deployment

### Update Parameter Files

- [ ] Update `infrastructure/bicep/parameters/dev.parameters.json` with Key Vault ID
- [ ] Update `infrastructure/bicep/parameters/staging.parameters.json` (if using staging)
- [ ] Update `infrastructure/bicep/parameters/prod.parameters.json` for production

### Deploy Infrastructure

- [ ] Validate Bicep templates (`.\scripts\validate-templates.ps1`)
- [ ] Deploy dev environment (`.\scripts\deploy-dev.ps1`)
- [ ] Verify all resources created successfully
- [ ] Capture deployment outputs (connection strings, URLs)

**Resources Created:**

- ✅ Virtual Network with subnets
- ✅ PostgreSQL with PostGIS extension
- ✅ Redis Cache
- ✅ Key Vault for application secrets
- ✅ Application Insights + Log Analytics
- ✅ Storage Account
- ✅ Container Registry
- ✅ Container Apps Environment
- ✅ API Container App
- ✅ **Azure Static Web App for frontend**

## 3. Extract Infrastructure Outputs

After deployment, capture these values for GitHub configuration:

- [ ] Get Application Insights connection string

  ```powershell
  az deployment group show `
    --name sunnyseat-dev-deployment `
    --resource-group sunnyseat-dev-rg `
    --query properties.outputs.appInsightsConnectionString.value -o tsv
  ```

- [ ] Get Static Web Apps deployment token

  ```powershell
  az staticwebapp secrets list `
    --name sunnyseat-dev-frontend `
    --resource-group sunnyseat-dev-rg `
    --query properties.apiKey -o tsv
  ```

- [ ] Get frontend URL

  ```powershell
  az deployment group show `
    --name sunnyseat-dev-deployment `
    --resource-group sunnyseat-dev-rg `
    --query properties.outputs.frontendUrl.value -o tsv
  ```

- [ ] Get API URL
  ```powershell
  az deployment group show `
    --name sunnyseat-dev-deployment `
    --resource-group sunnyseat-dev-rg `
    --query properties.outputs.apiUrl.value -o tsv
  ```

## 4. GitHub Secrets Configuration

Navigate to GitHub repository settings: `https://github.com/[org]/SunnySeat/settings/secrets/actions`

### Required Secrets

- [ ] Add `AZURE_STATIC_WEB_APPS_API_TOKEN`

  - Value: [Deployment token from Step 3]

- [ ] Add `VITE_APPLICATIONINSIGHTS_CONNECTION_STRING`

  - Value: [Connection string from Step 3]

- [ ] Add `AZURE_CREDENTIALS` (for backend deployment via Actions)
  ```powershell
  # Create service principal for GitHub Actions
  $subscriptionId = az account show --query id -o tsv
  az ad sp create-for-rbac `
    --name "github-actions-sunnyseat" `
    --role contributor `
    --scopes /subscriptions/$subscriptionId/resourceGroups/sunnyseat-dev-rg `
    --sdk-auth
  # Copy entire JSON output
  ```

### Verify Secrets

- [ ] Go to Settings → Secrets and variables → Actions
- [ ] Confirm all three secrets are listed

## 5. Environment Variables

### Production Environment File

- [ ] Update `.env.production` with values from deployment:
  ```env
  VITE_APPLICATIONINSIGHTS_CONNECTION_STRING=[from step 3]
  VITE_APP_URL=[frontendUrl from step 3]
  VITE_API_BASE_URL=[apiUrl from step 3]
  VITE_MAP_DEFAULT_CENTER_LNG=11.9746
  VITE_MAP_DEFAULT_CENTER_LAT=57.7089
  VITE_MAP_DEFAULT_ZOOM=12
  VITE_LOG_LEVEL=error
  ```

### Azure Static Web Apps Environment Variables

Configure via Azure CLI:

```powershell
az staticwebapp appsettings set `
  --name sunnyseat-dev-frontend `
  --resource-group sunnyseat-dev-rg `
  --setting-names `
    "VITE_APPLICATIONINSIGHTS_CONNECTION_STRING=<value>" `
    "VITE_APP_URL=<value>" `
    "VITE_API_BASE_URL=<value>"
```

Or via Azure Portal:

- [ ] Navigate to Static Web App in Azure Portal
- [ ] Go to "Configuration" blade
- [ ] Add environment variables as needed

## 6. Custom Domain & SSL (Optional - Post-MVP)

**Note:** Custom domain configuration can be done after initial deployment.

### Configure Custom Domain

```powershell
# Add custom domain to Static Web App
az staticwebapp hostname set `
  --name sunnyseat-prod-frontend `
  --resource-group sunnyseat-prod-rg `
  --hostname sunnyseat.com
```

Or via Azure Portal:

- [ ] Navigate to Static Web App → Custom domains
- [ ] Click "Add"
- [ ] Enter domain: sunnyseat.com
- [ ] Follow DNS configuration instructions
- [ ] Wait for SSL certificate provisioning (automatic, 5-10 minutes)

### DNS Configuration

Add CNAME record to your DNS provider:

```
Type: CNAME
Name: www (or @)
Value: sunnyseat-prod-frontend.azurestaticapps.net
TTL: 3600
```

## 7. Sitemap.xml

**Status:** ✅ Static sitemap already exists at `src/frontend/admin/public/sitemap.xml`

For dynamic sitemap generation based on venue data:

- [ ] Implement sitemap generation endpoint in backend API (future enhancement)
- [ ] Generate sitemap on venue data changes
- [ ] Update static sitemap manually as needed for now
- [ ] Submit to Google Search Console (see Step 11)

## 8. Testing & Validation

### Build Test

- [ ] Run build locally: `npm run build`
- [ ] Verify no errors
- [ ] Check bundle sizes in output
- [ ] Review stats.html (if visualizer enabled)

### Lighthouse Audit

- [ ] Build and preview: `npm run build && npm run preview`
- [ ] Run Lighthouse: `npx lighthouse http://localhost:4173 --view`
- [ ] Verify scores:
  - Performance: >80
  - SEO: >90
  - Accessibility: >90
  - PWA: >70

### PWA Testing

- [ ] Test on Chrome Desktop (install prompt)
- [ ] Test on Chrome Android (install to home screen)
- [ ] Test on Safari iOS (add to home screen)
- [ ] Verify offline functionality
- [ ] Verify map tiles cached offline

### SEO Validation

- [ ] Test structured data: https://search.google.com/test/rich-results
- [ ] Paste venue page URL
- [ ] Verify LocalBusiness schema detected
- [ ] Check for errors

### Error Boundary Testing

- [ ] Trigger error in component (add throw new Error())
- [ ] Verify fallback UI displays
- [ ] Check Application Insights for logged error
- [ ] Verify reload button works

## 9. Initial Deployment

### Deploy Frontend to Static Web Apps

**Option A: Using Azure CLI**

```powershell
cd src/frontend/admin

# Install dependencies
npm install

# Build for production
npm run build

# Upload to Static Web App
az staticwebapp upload `
  --name sunnyseat-dev-frontend `
  --resource-group sunnyseat-dev-rg `
  --app-location . `
  --output-location dist
```

**Option B: Using GitHub Actions (Recommended)**

- [ ] Ensure GitHub secrets are configured (Step 4)
- [ ] Commit code changes
- [ ] Push to main branch
- [ ] Monitor GitHub Actions workflow at `https://github.com/[org]/SunnySeat/actions`
- [ ] Verify deployment succeeds (3-5 minutes)

### Verify Deployment

```powershell
# Check Static Web App status
az staticwebapp show `
  --name sunnyseat-dev-frontend `
  --resource-group sunnyseat-dev-rg `
  --query "{name:name, url:defaultHostname, status:sku.tier}"

# Open in browser
Start-Process "https://sunnyseat-dev-frontend.azurestaticapps.net"
```

### Production Verification

- [ ] Visit production URL
- [ ] Test all major features (map, search, venue details)
- [ ] Verify PWA installable (install icon in browser)
- [ ] Check Application Insights receiving data (Azure Portal → Live Metrics)
- [ ] Monitor Core Web Vitals in Application Insights

## 10. Monitoring Setup

**Note:** Application Insights and Log Analytics are already deployed via Bicep templates.

### Application Insights Dashboards

Create custom dashboard for Web Vitals via Azure Portal or CLI:

```powershell
# View available metrics
az monitor app-insights metrics show `
  --app sunnyseat-dev-insights `
  --resource-group sunnyseat-dev-rg `
  --metric "performanceCounters/requestsPerSecond" `
  --interval PT1H
```

Dashboard metrics to track:

- [ ] LCP (Largest Contentful Paint)
- [ ] FID (First Input Delay)
- [ ] CLS (Cumulative Layout Shift)
- [ ] Page Load Time
- [ ] Error Rate
- [ ] User sessions

### Alerts Configuration

```powershell
# Create alert for high error rate
az monitor metrics alert create `
  --name "High Error Rate" `
  --resource-group sunnyseat-dev-rg `
  --scopes /subscriptions/<sub-id>/resourceGroups/sunnyseat-dev-rg/providers/Microsoft.Insights/components/sunnyseat-dev-insights `
  --condition "avg exceptions/server > 10" `
  --window-size 5m `
  --evaluation-frequency 1m
```

Or configure via Azure Portal:

- [ ] Create alert for error rate > 5%
- [ ] Create alert for LCP > 3s
- [ ] Create alert for availability < 99%
- [ ] Configure notification channels (email, Slack, etc.)

### Azure Monitor

- [ ] Enable Azure Monitor for Static Web Apps
- [ ] Log Analytics workspace already configured via Bicep
- [ ] Set up availability tests (ping) if needed

## 11. Google Search Console

### Setup

- [ ] Add property: https://sunnyseat.com
- [ ] Verify ownership (DNS TXT record or HTML file)
- [ ] Submit sitemap.xml
- [ ] Request indexing for key pages

### Monitor

- [ ] Check coverage reports
- [ ] Fix any indexing issues
- [ ] Monitor Core Web Vitals report
- [ ] Check mobile usability

## 12. Performance Optimization Iteration

### Baseline Measurement

- [ ] Document initial Lighthouse scores
- [ ] Document initial bundle sizes
- [ ] Document initial LCP/FID/CLS metrics

### Continuous Improvement

- [ ] Review bundle stats after each build
- [ ] Monitor real-world Web Vitals
- [ ] Adjust caching strategies based on usage
- [ ] Optimize images (WebP conversion)
- [ ] Review and prune unused dependencies

## Completion Criteria

All items above must be checked before marking Story 5.1 as "Done":

- [x] PWA icons generated and placed in correct directories
- [ ] Azure infrastructure deployed via Bicep templates
- [ ] Infrastructure outputs captured (connection strings, URLs, tokens)
- [ ] GitHub secrets configured (deployment token, App Insights, Azure credentials)
- [ ] Environment variables set (`.env.production` and Static Web App settings)
- [ ] Frontend deployed to Static Web Apps
- [ ] Deployment verified and accessible
- [ ] Lighthouse scores meet targets (Performance >80, SEO >90, Accessibility >90, PWA >70)
- [ ] PWA installable on major platforms
- [ ] SEO validation passes (structured data, sitemap)
- [ ] Monitoring configured (Application Insights, alerts)
- [ ] Google Search Console configured (optional for MVP)

## Summary of Infrastructure as Code Approach

✅ **What's automated via Bicep:**

- Virtual Network and subnets
- PostgreSQL with PostGIS
- Redis Cache
- Key Vault
- Application Insights + Log Analytics
- Storage Account
- Container Registry
- Container Apps Environment + API
- **Azure Static Web Apps**

✅ **What's manual:**

- PWA icons generation (one-time asset creation)
- GitHub Secrets configuration
- Environment variable files (`.env.production`)
- Custom domain DNS configuration (optional)
- Google Search Console setup (optional)
- Testing and validation

## Next Steps After Story 5.1

1. **Story 5.2:** CI/CD pipeline optimization
2. **Story 5.3:** Staging environment setup
3. **Story 5.4:** Production deployment and custom domain
4. **Story 5.5:** Monitoring dashboards and operational runbooks

## References & Resources

- **Deployment Guide:** `docs/ops/DEPLOYMENT-GUIDE.md` (comprehensive step-by-step instructions)
- [Azure Bicep Documentation](https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/)
- [Azure Static Web Apps Documentation](https://learn.microsoft.com/en-us/azure/static-web-apps/)
- [Application Insights JavaScript SDK](https://learn.microsoft.com/en-us/azure/azure-monitor/app/javascript)
- [Vite PWA Plugin Docs](https://vite-pwa-org.netlify.app/)
- [Google Search Console](https://search.google.com/search-console)
- [Lighthouse CI](https://github.com/GoogleChrome/lighthouse-ci)
